{% extends "base.html" %}

{% block title %}{{ _('VGM Iftarkaart - Ramadan 1446/2025') }}{% endblock %}

{% block styles %}
<style>
/* Main Layout */
.main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

/* Filter Panel */
.filter-panel {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

/* Calendar Styling */
.calendar-container {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.calendar-grid {
    width: 100%;
    border-collapse: separate;
    border-spacing: 3px;
}

.calendar-day {
    height: 120px;
    padding: 0.5rem;
    border-radius: 8px;
    background-color: #f8f9fa;
    vertical-align: top;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.calendar-day:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
}

.calendar-day.today {
    background-color: #e8f4f8;
    border: 2px solid #0dcaf0;
}

.calendar-day.has-events {
    background-color: #fff;
    border: 1px solid #dee2e6;
}

/* Event Indicators */
.event-indicators {
    display: flex;
    gap: 0.25rem;
    margin-top: 0.5rem;
}

.event-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.event-dot.daily { background-color: #198754; }
.event-dot.weekly { background-color: #0d6efd; }
.event-dot.single { background-color: #ffc107; }

/* Prayer Times */
.prayer-times {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

.prayer-time {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.25rem;
}

/* Map Container */
#map {
    height: 500px;
    width: 100%;
    border-radius: 12px;
    margin-bottom: 2rem;
}

/* Event List */
.events-list {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1.5rem;
}

.event-item {
    padding: 1rem;
    border-left: 4px solid transparent;
    margin-bottom: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.event-item:hover {
    transform: translateX(5px);
}

.event-item.daily { border-left-color: #198754; }
.event-item.weekly { border-left-color: #0d6efd; }
.event-item.single { border-left-color: #ffc107; }

/* Legend */
.calendar-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin: 1rem 0;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-container {
        padding: 1rem;
    }

    .calendar-day {
        height: 100px;
    }

    .prayer-times {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">{{ _('VGM Iftarkaart') }}</h1>
        {% if current_user.is_authenticated and (current_user.is_admin or current_user.user_type == 'mosque') %}
        <a href="{{ url_for('ramadan.add_iftar') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>{{ _('Voeg Iftar Toe') }}
        </a>
        {% endif %}
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel">
        <form id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label for="type" class="form-label">{{ _('Type Iftar') }}</label>
                <select class="form-select" name="type" id="type">
                    <option value="all" {% if iftar_type == 'all' %}selected{% endif %}>{{ _('Alle Types') }}</option>
                    <option value="daily" {% if iftar_type == 'daily' %}selected{% endif %}>{{ _('Dagelijks') }}</option>
                    <option value="weekly" {% if iftar_type == 'weekly' %}selected{% endif %}>{{ _('Wekelijks') }}</option>
                    <option value="single" {% if iftar_type == 'single' %}selected{% endif %}>{{ _('Eenmalig') }}</option>
                </select>
            </div>

            <div class="col-md-3">
                <label for="period" class="form-label">{{ _('Periode') }}</label>
                <select class="form-select" name="period" id="period">
                    <option value="all" {% if period == 'all' %}selected{% endif %}>{{ _('Volledige Ramadan') }}</option>
                    <option value="day" {% if period == 'day' %}selected{% endif %}>{{ _('Vandaag') }}</option>
                    <option value="three_days" {% if period == 'three_days' %}selected{% endif %}>{{ _('Komende 3 dagen') }}</option>
                    <option value="week" {% if period == 'week' %}selected{% endif %}>{{ _('Deze week') }}</option>
                </select>
            </div>

            <div class="col-md-3">
                <label for="mosque_id" class="form-label">{{ _('Moskee') }}</label>
                <select class="form-select" name="mosque_id" id="mosque_id">
                    <option value="">{{ _('Alle MoskeeÃ«n') }}</option>
                    {% for mosque in mosques %}
                    <option value="{{ mosque.id }}" {% if selected_mosque == mosque.id %}selected{% endif %}>
                        {{ mosque.mosque_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 d-flex flex-column justify-content-end">
                <div class="form-check mb-2">
                    <input type="checkbox" class="form-check-input" id="family_filter" name="filter" 
                           value="family" {% if family_only %}checked{% endif %}>
                    <label class="form-check-label" for="family_filter">
                        {{ _('Alleen Gezinsvriendelijk') }}
                    </label>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>{{ _('Filter Toepassen') }}
                </button>
            </div>
        </form>
    </div>

    <div class="row">
        <!-- Map and List View -->
        <div class="col-lg-7">
            <!-- Map -->
            <div id="map" class="mb-4"></div>

            <!-- Events List -->
            <div class="events-list">
                <h4 class="mb-3">{{ _('Geplande Iftars') }}</h4>
                {% for event in events %}
                    {% include 'ramadan/includes/iftar_card.html' %}
                {% endfor %}
            </div>
        </div>

        <!-- Calendar View -->
        <div class="col-lg-5">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h4 class="mb-0">{{ _('Ramadan 1446/2025') }}</h4>
                </div>

                <!-- Calendar Legend -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="event-dot daily"></span>
                        <span>{{ _('Dagelijks') }}</span>
                    </div>
                    <div class="legend-item">
                        <span class="event-dot weekly"></span>
                        <span>{{ _('Wekelijks') }}</span>
                    </div>
                    <div class="legend-item">
                        <span class="event-dot single"></span>
                        <span>{{ _('Eenmalig') }}</span>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <table class="calendar-grid">
                    <thead>
                        <tr>
                            <th>{{ _('Ma') }}</th>
                            <th>{{ _('Di') }}</th>
                            <th>{{ _('Wo') }}</th>
                            <th>{{ _('Do') }}</th>
                            <th>{{ _('Vr') }}</th>
                            <th>{{ _('Za') }}</th>
                            <th>{{ _('Zo') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set current_date = ramadan_start %}
                        {% set weeks = [] %}
                        {% set current_week = [] %}

                        {# Calculate first day offset #}
                        {% set first_day_offset = ramadan_start.weekday() %}

                        {# Add empty cells for days before start #}
                        {% for _ in range(first_day_offset) %}
                            {% set _ = current_week.append(None) %}
                        {% endfor %}

                        {# Generate calendar #}
                        {% while current_date <= ramadan_end %}
                            {# Get events for current date #}
                            {% set day_events = {'daily': [], 'weekly': [], 'single': []} %}
                            {% for event in events %}
                                {% if event.date == current_date %}
                                    {% if event.type == 'daily' %}
                                        {% set _ = day_events.daily.append(event) %}
                                    {% elif event.type == 'weekly' %}
                                        {% set _ = day_events.weekly.append(event) %}
                                    {% else %}
                                        {% set _ = day_events.single.append(event) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {# Add day to current week #}
                            {% set day_data = {
                                'date': current_date,
                                'day': current_date.day,
                                'is_today': current_date == today,
                                'has_events': day_events.daily|length > 0 or day_events.weekly|length > 0 or day_events.single|length > 0,
                                'events': day_events,
                                'event_count': day_events.daily|length + day_events.weekly|length + day_events.single|length,
                                'prayer_times': prayer_times.get(current_date, {}) if prayer_times else {}
                            } %}
                            {% set _ = current_week.append(day_data) %}

                            {# Start new week if needed #}
                            {% if current_week|length == 7 %}
                                {% set _ = weeks.append(current_week) %}
                                {% set current_week = [] %}
                            {% endif %}

                            {% set current_date = current_date + timedelta(days=1) %}
                        {% endwhile %}

                        {# Add remaining days #}
                        {% if current_week %}
                            {% for _ in range(7 - current_week|length) %}
                                {% set _ = current_week.append(None) %}
                            {% endfor %}
                            {% set _ = weeks.append(current_week) %}
                        {% endif %}

                        {# Render calendar #}
                        {% for week in weeks %}
                            <tr>
                                {% for day in week %}
                                    <td class="calendar-day {% if day and day.is_today %}today{% endif %} {% if day and day.has_events %}has-events{% endif %}"
                                        {% if day %}onclick="showDayDetails('{{ day.date.strftime('%Y-%m-%d') }}')"{% endif %}>
                                        {% if day %}
                                            <div class="d-flex justify-content-between">
                                                <span>{{ day.day }}</span>
                                                {% if day.has_events %}
                                                    <span class="badge bg-primary">{{ day.event_count }}</span>
                                                {% endif %}
                                            </div>

                                            {% if day.has_events %}
                                                <div class="event-indicators">
                                                    {% if day.events.daily %}
                                                        <span class="event-dot daily" title="{{ _('Dagelijkse iftars') }}"></span>
                                                    {% endif %}
                                                    {% if day.events.weekly %}
                                                        <span class="event-dot weekly" title="{{ _('Wekelijkse iftars') }}"></span>
                                                    {% endif %}
                                                    {% if day.events.single %}
                                                        <span class="event-dot single" title="{{ _('Eenmalige iftars') }}"></span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}

                                            {% if day.prayer_times %}
                                                <div class="prayer-times">
                                                    <div class="prayer-time">
                                                        <span>Maghrib:</span>
                                                        <span>{{ day.prayer_times.maghrib }}</span>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
<script>
let map;
let markers = [];
let events = {{ events_json|safe }};

function initMap() {
    // Center on Belgium
    const belgium = { lat: 50.8503, lng: 4.3517 };
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 8,
        center: belgium,
        styles: [
            {
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }
        ]
    });

    updateMarkers(events);
}

function updateMarkers(events) {
    // Clear existing markers
    markers.forEach(marker => marker.setMap(null));
    markers = [];

    const bounds = new google.maps.LatLngBounds();
    let hasValidMarkers = false;

    events.forEach(event => {
        if (event.latitude && event.longitude) {
            hasValidMarkers = true;
            const position = { lat: event.latitude, lng: event.longitude };
            bounds.extend(position);

            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: event.mosque_name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: getEventColor(event.type),
                    fillOpacity: 1,
                    strokeWeight: 0,
                    scale: 8
                }
            });

            const infowindow = new google.maps.InfoWindow({
                content: `
                    <div class="info-window">
                        <h5>${event.mosque_name}</h5>
                        <p>${event.date} ${event.start_time}</p>
                        <p>${event.location}</p>
                        ${event.is_family_friendly ? '<span class="badge bg-success">Gezinsvriendelijk</span>' : ''}
                    </div>
                `
            });

            marker.addListener("click", () => {
                infowindow.open(map, marker);
            });

            markers.push(marker);
        }
    });

    if (hasValidMarkers) {
        map.fitBounds(bounds);
        const listener = google.maps.event.addListener(map, "idle", () => {
            if (map.getZoom() > 12) map.setZoom(12);
            google.maps.event.removeListener(listener);
        });
    }
}

function getEventColor(type) {
    switch(type) {
        case 'daily': return '#198754';
        case 'weekly': return '#0d6efd';
        case 'single': return '#ffc107';
        default: return '#6c757d';
    }
}

function showDayDetails(date) {
    const modal = new bootstrap.Modal(document.getElementById('dayModal'));
    const modalTitle = document.querySelector('#dayModal .modal-title');
    const modalBody = document.querySelector('#dayModal .modal-body');

    const dateObj = new Date(date);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    modalTitle.textContent = dateObj.toLocaleDateString('nl-NL', options);

    const dayEvents = events.filter(event => event.date === date);
    const eventsByType = {
        daily: dayEvents.filter(e => e.type === 'daily'),
        weekly: dayEvents.filter(e => e.type === 'weekly'),
        single: dayEvents.filter(e => e.type === 'single')
    };

    let html = '';
    Object.entries(eventsByType).forEach(([type, typeEvents]) => {
        if (typeEvents.length > 0) {
            const typeLabels = {
                daily: 'Dagelijkse Iftars',
                weekly: 'Wekelijkse Iftars',
                single: 'Eenmalige Iftars'
            };

            html += `<h5 class="mb-3">${typeLabels[type]}</h5>`;
            typeEvents.forEach(event => {
                html += `
                    <div class="event-item ${type} mb-3">
                        <h6 class="mb-2">${event.mosque_name}</h6>
                        <p class="mb-2">
                            <i class="far fa-clock me-2"></i>${event.start_time}
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-map-marker-alt me-2"></i>${event.location}
                        </p>
                        <div class="d-flex gap-2">
                            ${event.is_family_friendly ? 
                              '<span class="badge bg-success"><i class="fas fa-users me-1"></i>Gezinsvriendelijk</span>' : ''}
                        </div>
                    </div>
                `;
            });
        }
    });

    modalBody.innerHTML = html || '<p class="text-muted">Geen iftars gevonden voor deze dag.</p>';
    modal.show();
}

// Filter form handling
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const params = new URLSearchParams(formData);
    window.location.href = `${window.location.pathname}?${params.toString()}`;
});
</script>
{% endblock %}
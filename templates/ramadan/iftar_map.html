{% extends "base.html" %}

{% block title %}{{ _('VGM Iftarkaart - Ramadan 1446/2025') }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">{{ _('VGM Iftarkaart') }}</h1>
        {% if current_user.is_authenticated and (current_user.is_admin or current_user.user_type == 'mosque') %}
        <a href="{{ url_for('ramadan.add_iftar') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>{{ _('Voeg Iftar Toe') }}
        </a>
        {% endif %}
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-4">
                    <label for="period" class="form-label">{{ _('Periode') }}</label>
                    <select class="form-select" name="period" id="period">
                        <option value="day" {% if period == 'day' %}selected{% endif %}>
                            {{ _('Vandaag') }}
                        </option>
                        <option value="week" {% if period == 'week' %}selected{% endif %}>
                            {{ _('Deze week') }}
                        </option>
                        <option value="all" {% if period == 'all' %}selected{% endif %}>
                            {{ _('Volledige Ramadan') }}
                        </option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="mosque_id" class="form-label">{{ _('Moskee') }}</label>
                    <select class="form-select" name="mosque_id" id="mosque_id">
                        <option value="">{{ _('Alle MoskeeÃ«n') }}</option>
                        {% for mosque in mosques %}
                        <option value="{{ mosque.id }}" {% if selected_mosque == mosque.id %}selected{% endif %}>
                            {{ mosque.mosque_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check me-3">
                        <input type="checkbox" class="form-check-input" id="family_filter" 
                               name="filter" value="family" {% if family_only %}checked{% endif %}>
                        <label class="form-check-label" for="family_filter">
                            {{ _('Alleen Gezinsvriendelijk') }}
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>{{ _('Filter') }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- Map View -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div id="map" style="height: 600px"></div>
                </div>
            </div>
        </div>

        <!-- Events List -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">{{ _('Geplande Iftars') }}</h5>
                    {% if events %}
                        {% for event in events %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">{{ event.mosque_name }}</h6>
                                <p class="card-text">
                                    <i class="far fa-calendar me-2"></i>
                                    {{ event.date.strftime('%d-%m-%Y') }}
                                </p>
                                <p class="card-text">
                                    <i class="far fa-clock me-2"></i>
                                    {{ event.start_time.strftime('%H:%M') }}
                                </p>
                                <p class="card-text">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    {{ event.location }}
                                </p>
                                {% if event.is_family_friendly %}
                                <span class="badge bg-success">
                                    <i class="fas fa-users me-1"></i>
                                    {{ _('Gezinsvriendelijk') }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">{{ _('Geen iftars gevonden voor deze periode.') }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Prayer Times -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">{{ _('Gebedstijden Vandaag') }}</h5>
                    {% if prayer_times and today in prayer_times %}
                        {% set times = prayer_times[today] %}
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Fajr</span>
                                <span>{{ times.fajr }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Dhuhr</span>
                                <span>{{ times.dhuhr }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Asr</span>
                                <span>{{ times.asr }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Maghrib</span>
                                <span>{{ times.maghrib }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Isha</span>
                                <span>{{ times.isha }}</span>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">{{ _('Geen gebedstijden beschikbaar.') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
<script>
let map;
let markers = [];
let events = {{ events_json|tojson|safe }};

function initMap() {
    // Center on Belgium
    const belgium = { lat: 50.8503, lng: 4.3517 };
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 8,
        center: belgium,
        styles: [{
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
        }]
    });

    updateMarkers();
}

function updateMarkers() {
    // Clear existing markers
    markers.forEach(marker => marker.setMap(null));
    markers = [];

    const bounds = new google.maps.LatLngBounds();
    let hasValidMarkers = false;

    events.forEach(event => {
        if (event.latitude && event.longitude) {
            hasValidMarkers = true;
            const position = { 
                lat: parseFloat(event.latitude), 
                lng: parseFloat(event.longitude) 
            };
            bounds.extend(position);

            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: event.mosque_name
            });

            const content = `
                <div class="info-window">
                    <h6>${event.mosque_name}</h6>
                    <p>${event.date} ${event.start_time}</p>
                    <p>${event.location}</p>
                    ${event.is_family_friendly ? 
                      '<span class="badge bg-success">Gezinsvriendelijk</span>' : 
                      ''}
                </div>
            `;

            const infowindow = new google.maps.InfoWindow({ content });
            marker.addListener("click", () => infowindow.open(map, marker));
            markers.push(marker);
        }
    });

    if (hasValidMarkers) {
        map.fitBounds(bounds);
        const listener = google.maps.event.addListener(map, "idle", () => {
            if (map.getZoom() > 12) map.setZoom(12);
            google.maps.event.removeListener(listener);
        });
    }
}

// Filter form handling
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const params = new URLSearchParams(formData);
    window.location.href = `${window.location.pathname}?${params.toString()}`;
});

// Debug Mode function
function debugIftarKaart() {
    // Check if debug panel already exists
    if (document.getElementById('debug-panel')) {
        document.getElementById('debug-panel').remove();
        return;
    }

    const debugEl = document.createElement('div');
    debugEl.id = 'debug-panel';
    debugEl.style.cssText = 'position:fixed;bottom:10px;right:10px;padding:10px;' +
                           'background:rgba(0,0,0,0.8);color:white;z-index:9999;' +
                           'max-height:300px;overflow:auto;font-family:monospace;';

    const updateDebug = async () => {
        try {
            debugEl.innerHTML = '<p>Loading debug data...</p>';
            const response = await fetch('/ramadan/api/debug-iftar');
            const data = await response.json();
            debugEl.innerHTML = `
                <h4>Debug Info</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
                <button onclick="document.getElementById('debug-panel').remove()" 
                        style="background:#ff4154;color:white;border:none;padding:5px 10px;border-radius:4px;margin-top:10px;">
                    Close
                </button>
            `;
        } catch (e) {
            debugEl.innerHTML = `<p>Error: ${e.message}</p>`;
        }
    };

    document.body.appendChild(debugEl);
    updateDebug();
}
</script>

{% if current_user.is_authenticated and current_user.is_admin %}
<script>
// Add Debug button for admins
document.addEventListener('DOMContentLoaded', () => {
    const debugBtn = document.createElement('button');
    debugBtn.classList.add('btn', 'btn-sm', 'btn-outline-secondary', 'position-fixed');
    debugBtn.style.bottom = '20px';
    debugBtn.style.left = '20px';
    debugBtn.style.zIndex = '1000';
    debugBtn.innerHTML = '<i class="fas fa-bug me-1"></i> Debug';
    debugBtn.addEventListener('click', debugIftarKaart);
    document.body.appendChild(debugBtn);
});
</script>
{% endif %}
{% endblock %}